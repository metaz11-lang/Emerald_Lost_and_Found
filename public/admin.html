<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Emerald Admin</title>
    <!-- Reuse main index head pieces by loading same bundle -->
    <script type="importmap">
    {
      "imports": {
        "drizzle-orm/pg-core": "/shims/drizzle-orm-pg-core.js",
        "drizzle-zod": "/shims/drizzle-zod.js",
        "zod": "/shims/zod.js"
      }
    }
    </script>
    <script>
      // Minimal redirect safety: if loaded at /admin.html ensure location shows /admin for consistency
      if (location.pathname.endsWith('/admin.html')) {
        history.replaceState({}, '', '/admin');
      }
    </script>
    <script type="module" crossorigin src="/assets/index-3b3d0452.js"></script>
    <link rel="stylesheet" href="/assets/index-7f6cc192.css">
  </head>
  <body>
    <div id="root"></div>
    <script>
      // Diagnostic overlay to verify admin status and disc retrieval independent of React rendering
      (async function(){
        try {
          const box = document.createElement('div');
          box.style.position='fixed';box.style.top='8px';box.style.right='8px';box.style.zIndex=9999999;box.style.background='#0f172a';box.style.color='#e2e8f0';box.style.font='12px system-ui,Segoe UI,Arial';box.style.padding='8px 10px';box.style.border='1px solid #334155';box.style.borderRadius='6px';box.style.maxWidth='260px';box.style.lineHeight='1.3';
          box.textContent='[emerald] probing admin status...';
          document.addEventListener('DOMContentLoaded',()=>document.body.appendChild(box));
          const statusRes = await fetch('/api/admin/status',{credentials:'include'});
          let statusJson=null; try { statusJson = await statusRes.json(); } catch {}
          const discsRes = await fetch('/api/admin/discs',{credentials:'include'});
            let discsJson=null; try { discsJson = await discsRes.json(); } catch {}
          const count = Array.isArray(discsJson)? discsJson.length : 'n/a';
          box.innerHTML = '<b>Admin Debug</b><br>'+
            'status: '+statusRes.status+' '+JSON.stringify(statusJson)+'<br>'+
            'discs: '+discsRes.status+' count='+count+'<br>'+
            '<button id="emerald-hide-box" style="margin-top:4px;background:#334155;color:#fff;border:none;padding:2px 6px;border-radius:4px;cursor:pointer;">Hide</button>';
          box.querySelector('#emerald-hide-box').onclick=()=>box.remove();
          // Auto remove after 15s if everything looks good
          if (statusRes.ok && statusJson && statusJson.isAdmin && discsRes.ok && typeof count==='number' && count>=0) {
            setTimeout(()=>{ try { box.remove(); } catch {} }, 15000);
          }
        } catch (e) { console.error('[emerald][admin diag] failed', e); }
      })();
      
      // Listen for disc creation events and force refresh
      window.addEventListener('discCreated', () => {
        console.log('[emerald][admin] disc created, forcing page reload in 500ms');
        setTimeout(() => location.reload(), 500);
      });
      
      // Also check for successful form submissions on the main page
      setInterval(async () => {
        if (window.lastDiscCount === undefined) {
          try {
            const res = await fetch('/api/discs');
            if (res.ok) {
              const discs = await res.json();
              window.lastDiscCount = discs.length;
            }
          } catch {}
        } else {
          try {
            const res = await fetch('/api/discs');
            if (res.ok) {
              const discs = await res.json();
              if (discs.length > window.lastDiscCount) {
                console.log('[emerald][admin] disc count increased, refreshing');
                location.reload();
              }
              window.lastDiscCount = discs.length;
            }
          } catch {}
        }
      }, 2000);
    </script>
  </body>
</html>
