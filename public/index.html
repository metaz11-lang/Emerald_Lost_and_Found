<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1" />
    <!-- Import map to redirect server-only/bare imports to lightweight browser shims -->
    <script type="importmap">
    {
      "imports": {
        "drizzle-orm/pg-core": "/shims/drizzle-orm-pg-core.js",
        "drizzle-zod": "/shims/drizzle-zod.js",
        "zod": "/shims/zod.js"
      }
    }
    </script>
    <!-- Small diagnostics helper: log load and surface uncaught errors to the page for easier debugging -->
    <script>
      try {
        console.log('[emerald] index.html loaded');
        // Create a small overlay to show uncaught errors so the user can paste it here easily
        const overlay = document.createElement('div');
        overlay.id = 'emerald-error-overlay';
        overlay.style.position = 'fixed';
        overlay.style.left = '12px';
        overlay.style.right = '12px';
        overlay.style.top = '12px';
        overlay.style.zIndex = 9999999;
        overlay.style.background = 'rgba(255,255,255,0.95)';
        overlay.style.color = '#b91c1c';
        overlay.style.border = '1px solid rgba(185,28,28,0.2)';
        overlay.style.padding = '12px';
        overlay.style.fontFamily = 'system-ui,Segoe UI,Roboto,Arial';
        overlay.style.fontSize = '13px';
        overlay.style.maxHeight = '60vh';
        overlay.style.overflow = 'auto';
        overlay.style.display = 'none';
        document.addEventListener('DOMContentLoaded', () => document.body.appendChild(overlay));

        function showError(msg) {
          console.error('[emerald] runtime error:', msg);
          overlay.style.display = 'block';
          overlay.textContent = typeof msg === 'string' ? msg : (msg && msg.stack) ? msg.stack : JSON.stringify(msg);
        }

        window.addEventListener('error', (ev) => {
          showError(ev.error || ev.message || 'Unknown error');
        });
        window.addEventListener('unhandledrejection', (ev) => {
          showError(ev.reason || 'Unhandled rejection');
        });

        // Patch fetch to observe disc creation responses and fire events the bundle could optionally listen for.
        const originalFetch = window.fetch;
        window.fetch = async function patchedFetch(input, init) {
          try {
            const res = await originalFetch(input, init);
            // Detect successful disc creation
            const url = (typeof input === 'string' ? input : input.url || '').toLowerCase();
            if (url.includes('/api/discs') && init && (init.method||'').toUpperCase() === 'POST' && res.ok) {
              console.log('[emerald][debug] POST /api/discs success -> dispatching discCreated event');
              try { window.dispatchEvent(new CustomEvent('discCreated')); } catch {}
            }
            // Fallback for admin list: if /api/admin/discs 404s, try public /api/discs instead
            if (url.includes('/api/admin/discs') && res.status === 404 && (!init || (init.method||'GET').toUpperCase()==='GET')) {
              console.log('[emerald][debug] /api/admin/discs returned 404, falling back to /api/discs');
              try {
                const alt = await originalFetch('/api/discs', { headers: { 'Accept':'application/json' } });
                // Construct a Response-like object with alt body but original status if alt ok
                if (alt.ok) return alt; // let caller treat it as success
              } catch (e) {
                console.warn('[emerald][debug] fallback /api/discs failed', e);
              }
            }
            return res;
          } catch (e) {
            console.error('[emerald][debug] fetch error', e);
            throw e;
          }
        };

        // When a disc is created, force a refresh on /admin so new entries show immediately.
        window.addEventListener('discCreated', () => {
          if (location.pathname.startsWith('/admin')) {
            console.log('[emerald][debug] auto-reloading admin view after discCreated');
            location.reload();
          }
        });
      } catch (e) {
        try { console.error(e); } catch {};
      }
    </script>
    <script type="module" crossorigin src="/assets/index-3b3d0452.js"></script>
    <link rel="stylesheet" href="/assets/index-7f6cc192.css">
  </head>
  <body>
    <div id="root"></div>
    <div style="position:fixed;left:12px;bottom:12px;z-index:999998;font:14px system-ui,Segoe UI,Arial;">
      <a href="/admin-basic" style="background:#065f46;color:#fff;text-decoration:none;padding:8px 12px;border-radius:6px;box-shadow:0 2px 4px rgba(0,0,0,.25);font-weight:600;">Basic Admin Page</a>
    </div>
    <div id="emerald-debug-tools" style="position:fixed;bottom:8px;right:8px;background:#0f172a;color:#f1f5f9;font:12px system-ui,Segoe UI,Arial;padding:8px 10px;border-radius:6px;box-shadow:0 2px 6px rgba(0,0,0,.35);z-index:999999;line-height:1.4;display:none;">
      <div style="font-weight:600;margin-bottom:4px;">Emerald Debug</div>
      <button id="dbg-list" style="margin:2px 0;padding:2px 6px;font-size:12px;cursor:pointer;">List Discs</button>
      <button id="dbg-seed" style="margin:2px 0;padding:2px 6px;font-size:12px;cursor:pointer;">Seed If Empty</button>
      <pre id="dbg-out" style="margin:4px 0 0;max-width:260px;max-height:140px;overflow:auto;background:#1e293b;color:#e2e8f0;padding:4px 6px;border-radius:4px;"></pre>
      <div style="text-align:right;margin-top:4px;"><button id="dbg-close" style="background:#334155;color:#f8fafc;border:none;padding:2px 6px;border-radius:3px;cursor:pointer;">Close</button></div>
    </div>
    <script>
      (function(){
        // Show panel automatically if query ?debug=1 or local dev
        const debug = /[?&]debug=1/.test(location.search) || location.hostname === 'localhost';
        if(!debug) return;
        const panel = document.getElementById('emerald-debug-tools');
        if(!panel) return;
        panel.style.display='block';
        const out = document.getElementById('dbg-out');
        function w(msg){ out.textContent = (msg instanceof Error? msg.stack: typeof msg==='object'? JSON.stringify(msg,null,2): String(msg)); }
        document.getElementById('dbg-close').onclick=()=>panel.remove();
        document.getElementById('dbg-list').onclick=async()=>{
          try{
            const r = await fetch('/api/admin/discs', { headers: { 'Accept':'application/json' }});
            const text = await r.text();
            let data;
            try { data = JSON.parse(text); } catch { return w({ status:r.status, note:'Non-JSON response', snippet: text.slice(0,120) }); }
            w({status:r.status, count:Array.isArray(data)?data.length:'n/a', first:Array.isArray(data)?(data[0]||null):data});
          }catch(e){ w(e); }
        };
        document.getElementById('dbg-seed').onclick=async()=>{
          try{
            const r = await fetch('/api/debug/seed',{method:'POST', headers:{'Accept':'application/json'}});
            const text = await r.text();
            try { w(JSON.parse(text)); } catch { w({ status:r.status, note:'Seed non-JSON', snippet:text.slice(0,120) }); }
          }catch(e){ w(e); }
        };
      })();
    </script>
    
    <!-- This is a replit script which adds a banner on the top of the page when opened in development mode outside the replit environment -->
    <script type="text/javascript" src="https://replit.com/public/js/replit-dev-banner.js"></script>
  </body>
</html>